# backend/tests/test_api.py
"""
API Tests Template - Generated from Golden Seed
================================================
Derek uses this as a base and customizes it for project-specific entities.

This template includes:
1. Health check test (always passes)
2. Placeholder CRUD tests for the primary entity

To customize:
- Replace {{ENTITY}} with the primary entity name (e.g., "expense", "task")
- Replace {{ENTITY_PLURAL}} with the plural form (e.g., "expenses", "tasks")
- Replace {{MODEL_NAME}} with the model class name (e.g., "Expense", "Task")
"""
import pytest
from faker import Faker

# Initialize Faker for realistic test data
fake = Faker()


# ═══════════════════════════════════════════════════════
# HEALTH CHECK (Always include - validates API is running)
# ═══════════════════════════════════════════════════════

@pytest.mark.anyio
async def test_health_check(client):
    """Test the health check endpoint."""
    response = await client.get("/api/health")
    assert response.status_code == 200
    data = response.json()
    assert data.get("status") == "healthy"


# ═══════════════════════════════════════════════════════
# {{ENTITY}} CRUD TESTS
# Replace {{ENTITY}}, {{ENTITY_PLURAL}}, {{MODEL_NAME}} with actual values
# ═══════════════════════════════════════════════════════

@pytest.mark.anyio
async def test_list_{{ENTITY_PLURAL}}_empty(client):
    """Test listing {{ENTITY_PLURAL}} when none exist."""
    response = await client.get("/api/{{ENTITY_PLURAL}}")
    assert response.status_code == 200
    data = response.json()
    # Response should have data array (may be empty or contain items)
    assert "data" in data or isinstance(data, list)


@pytest.mark.anyio
async def test_create_{{ENTITY}}(client):
    """Test creating a new {{ENTITY}}."""
    # Use generic fields that match standard contract schema
    {{ENTITY}}_data = {
        "title": fake.sentence(nb_words=4),
        "description": fake.paragraph(nb_sentences=2),
    }
    response = await client.post("/api/{{ENTITY_PLURAL}}", json={{ENTITY}}_data)
    assert response.status_code in [200, 201]
    data = response.json()
    # Response should contain the created entity or a data wrapper
    if "data" in data:
        assert "title" in data["data"] or "id" in data["data"]
    else:
        assert "title" in data or "id" in data or "_id" in data


@pytest.mark.anyio
async def test_get_{{ENTITY}}_not_found(client):
    """Test getting a non-existent {{ENTITY}} returns 404."""
    # Use a valid but non-existent ObjectId
    fake_id = "507f1f77bcf86cd799439011"
    response = await client.get(f"/api/{{ENTITY_PLURAL}}/{fake_id}")
    assert response.status_code == 404


# ═══════════════════════════════════════════════════════
# Additional Tests (Uncomment and customize as needed)
# ═══════════════════════════════════════════════════════

# @pytest.mark.anyio
# async def test_update_{{ENTITY}}(client):
#     """Test updating an existing {{ENTITY}}."""
#     # First create a {{ENTITY}}
#     create_data = {"title": fake.sentence(), "content": fake.paragraph()}
#     create_response = await client.post("/api/{{ENTITY_PLURAL}}", json=create_data)
#     created = create_response.json()
#     {{ENTITY}}_id = created.get("id") or created.get("_id") or created.get("data", {}).get("id")
#     
#     # Then update it
#     update_data = {"title": fake.sentence()}
#     response = await client.put(f"/api/{{ENTITY_PLURAL}}/{{{ENTITY}}_id}", json=update_data)
#     assert response.status_code == 200


# @pytest.mark.anyio
# async def test_delete_{{ENTITY}}(client):
#     """Test deleting a {{ENTITY}}."""
#     # First create
#     create_data = {"title": fake.sentence()}
#     create_response = await client.post("/api/{{ENTITY_PLURAL}}", json=create_data)
#     created = create_response.json()
#     {{ENTITY}}_id = created.get("id") or created.get("_id") or created.get("data", {}).get("id")
#     
#     # Then delete
#     response = await client.delete(f"/api/{{ENTITY_PLURAL}}/{{{ENTITY}}_id}")
#     assert response.status_code in [200, 204]
