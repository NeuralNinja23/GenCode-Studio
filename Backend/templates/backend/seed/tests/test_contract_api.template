"""
CONTRACT TEST TEMPLATE ‚Äì DETERMINISTIC

This template defines the MINIMUM REQUIRED API surface.
It MUST be rendered deterministically.
LLMs are NOT allowed to add, remove, or infer tests here.
"""

import pytest
from faker import Faker

fake = Faker()

# ============================================================
# üîí CONTRACT CONSTANTS (machine-readable, authoritative)
# ============================================================

BASE_PATH = "/api/{{ENTITY_PLURAL}}"


# ============================================================
# üìã LIST {{ENTITY_PLURAL|upper}}
# ============================================================

@pytest.mark.anyio
async def test_list_{{ENTITY_PLURAL}}_empty(client):
    """
    GET /api/{{ENTITY_PLURAL}}
    Must return 200 with an empty list when no {{ENTITY_PLURAL}} exist.
    """
    response = await client.get(BASE_PATH)

    assert response.status_code == 200, "GET /api/{{ENTITY_PLURAL}} MUST return 200"
    assert isinstance(response.json(), list), "Response MUST be a list"
    assert response.json() == [], "Initial {{ENTITY_PLURAL}} list MUST be empty"


# ============================================================
# ‚ûï CREATE {{ENTITY|upper}}
# ============================================================

@pytest.mark.anyio
async def test_create_{{ENTITY}}(client):
    """
    POST /api/{{ENTITY_PLURAL}}
    Must create a {{ENTITY}} and return 201 Created.
    """
    payload = {
        "title": fake.sentence(),
        "description": fake.text(),
    }

    response = await client.post(BASE_PATH, json=payload)

    assert response.status_code == 201, "POST /api/{{ENTITY_PLURAL}} MUST return 201 Created"

    data = response.json()
    assert "id" in data, "Created {{ENTITY}} MUST have an id"


# ============================================================
# üîç GET {{ENTITY|upper}} BY ID
# ============================================================

@pytest.mark.anyio
async def test_get_{{ENTITY}}_success(client):
    """
    GET /api/{{ENTITY_PLURAL}}/{id}
    Must return 200 for an existing {{ENTITY}}.
    """
    payload = {
        "title": fake.sentence(),
        "description": fake.text(),
    }

    create_response = await client.post(BASE_PATH, json=payload)
    assert create_response.status_code == 201

    item_id = create_response.json()["id"]

    response = await client.get(f"{BASE_PATH}/{item_id}")

    assert response.status_code == 200, "GET /api/{{ENTITY_PLURAL}}/{id} MUST return 200"
    assert response.json()["id"] == item_id


# ============================================================
# ‚ùå GET MISSING {{ENTITY|upper}}
# ============================================================

@pytest.mark.anyio
async def test_get_{{ENTITY}}_not_found(client):
    """
    GET /api/{{ENTITY_PLURAL}}/{id}
    Must return 404 for a non-existent {{ENTITY}}.
    """
    # Use valid ObjectId format (24 hex chars) that won't exist in DB
    response = await client.get(f"{BASE_PATH}/000000000000000000000000")

    assert response.status_code == 404, "Missing {{ENTITY}} MUST return 404"


# ============================================================
# üóëÔ∏è DELETE {{ENTITY|upper}}
# ============================================================

@pytest.mark.anyio
async def test_delete_{{ENTITY}}(client):
    """
    DELETE /api/{{ENTITY_PLURAL}}/{id}
    Must delete the {{ENTITY}} and return 204 No Content.
    """
    # Use actual entity fields from models.py - example:
    # payload = {"title": fake.sentence(), "description": fake.text()}
    payload = {
        "title": fake.sentence(),
        "description": fake.text(),
    }

    create_response = await client.post(BASE_PATH, json=payload)
    assert create_response.status_code == 201

    item_id = create_response.json()["id"]

    delete_response = await client.delete(f"{BASE_PATH}/{item_id}")

    assert delete_response.status_code == 204, "DELETE MUST return 204 No Content"

    # Verify deletion
    get_response = await client.get(f"{BASE_PATH}/{item_id}")
    assert get_response.status_code == 404, "Deleted {{ENTITY}} MUST return 404"
