"""
AUTHORITATIVE BACKEND CONTRACT â€“ DO NOT MODIFY AT RUNTIME

This test file DEFINES the required API surface for the backend.
If any test fails, the backend implementation is INVALID.

âš ï¸ Healing rules:
- Backend code MAY be modified to satisfy these tests
- Tests MUST NOT be modified or relaxed
- Route prefixes, methods, and status codes are STRICT
"""

import pytest
from faker import Faker

fake = Faker()

# ============================================================
# ğŸ”’ CONTRACT CONSTANTS (machine-readable, authoritative)
# ============================================================

TASKS_BASE = "/api/tasks"


# ============================================================
# ğŸ“‹ LIST TASKS
# ============================================================

@pytest.mark.anyio
async def test_list_tasks_empty(client):
    """
    GET /api/tasks
    Must return 200 with an empty list when no tasks exist.
    """
    response = await client.get(TASKS_BASE)

    assert response.status_code == 200, "GET /api/tasks MUST return 200"
    assert isinstance(response.json(), list), "Response MUST be a list"
    assert response.json() == [], "Initial task list MUST be empty"


# ============================================================
# â• CREATE TASK
# ============================================================

@pytest.mark.anyio
async def test_create_task(client):
    """
    POST /api/tasks
    Must create a task and return 201 Created.
    """
    task_data = {
        "title": fake.sentence(nb_words=4),
        "description": fake.paragraph(nb_sentences=2),
        "status": "active",
    }

    response = await client.post(TASKS_BASE, json=task_data)

    assert response.status_code == 201, "POST /api/tasks MUST return 201 Created"

    data = response.json()

    assert "id" in data, "Created task MUST have an id"
    assert data["title"] == task_data["title"]
    assert data["description"] == task_data["description"]
    assert data["status"] == task_data["status"]


# ============================================================
# ğŸ” GET TASK BY ID
# ============================================================

@pytest.mark.anyio
async def test_get_task_success(client):
    """
    GET /api/tasks/{task_id}
    Must return 200 for an existing task.
    """
    task_data = {
        "title": fake.sentence(nb_words=4),
        "description": fake.paragraph(nb_sentences=2),
        "status": "active",
    }

    create_response = await client.post(TASKS_BASE, json=task_data)
    assert create_response.status_code == 201

    task_id = create_response.json()["id"]

    response = await client.get(f"{TASKS_BASE}/{task_id}")

    assert response.status_code == 200, "GET /api/tasks/{id} MUST return 200"
    assert response.json()["id"] == task_id


# ============================================================
# âŒ GET MISSING TASK
# ============================================================

@pytest.mark.anyio
async def test_get_task_not_found(client):
    """
    GET /api/tasks/{task_id}
    Must return 404 for a non-existent task.
    """
    response = await client.get(f"{TASKS_BASE}/nonexistent-id")

    assert response.status_code == 404, "Missing task MUST return 404"


# ============================================================
# ğŸ—‘ï¸ DELETE TASK
# ============================================================

@pytest.mark.anyio
async def test_delete_task(client):
    """
    DELETE /api/tasks/{task_id}
    Must delete the task and return 204 No Content.
    """
    task_data = {
        "title": fake.sentence(nb_words=4),
        "description": fake.paragraph(nb_sentences=2),
        "status": "active",
    }

    create_response = await client.post(TASKS_BASE, json=task_data)
    assert create_response.status_code == 201

    task_id = create_response.json()["id"]

    delete_response = await client.delete(f"{TASKS_BASE}/{task_id}")

    assert delete_response.status_code == 204, "DELETE MUST return 204 No Content"

    # Verify deletion
    get_response = await client.get(f"{TASKS_BASE}/{task_id}")
    assert get_response.status_code == 404, "Deleted task MUST return 404"
